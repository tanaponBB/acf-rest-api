# Cloud Build configuration for ACF REST API Plugin
# Triggers on push to main/master branch
#
# Required substitutions (set in Cloud Build trigger):
# - _BUCKET: Your GCS bucket name (e.g., my-wp-plugins)
# - _PLUGIN_SLUG: Plugin folder name (default: acf-rest-api)

steps:
  # Step 1: Extract version from plugin header and save to file
  - name: 'ubuntu'
    id: 'extract-version'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(grep -oP "Version:\s*\K[0-9.]+" ${_PLUGIN_SLUG}.php || echo "1.0.0")
        if [ -z "$VERSION" ]; then
          echo "âŒ Could not extract version from ${_PLUGIN_SLUG}.php"
          exit 1
        fi
        echo "âœ… Detected version: $VERSION"
        echo "$VERSION" > /workspace/version.txt

  # Step 2: Create plugin ZIP file
  - name: 'ubuntu'
    id: 'create-zip'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update && apt-get install -y zip
        VERSION=$(cat /workspace/version.txt)
        echo "Creating ZIP for version $VERSION"
        
        # Create build directory with plugin folder structure
        mkdir -p build/${_PLUGIN_SLUG}
        
        # Copy all plugin files
        cp -r ${_PLUGIN_SLUG}.php build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        cp -r includes build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        cp -r assets build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        cp -r languages build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        cp readme.txt build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        
        # Create ZIP
        cd build
        zip -r ${_PLUGIN_SLUG}-${VERSION}.zip ${_PLUGIN_SLUG}
        cp ${_PLUGIN_SLUG}-${VERSION}.zip ${_PLUGIN_SLUG}-latest.zip
        
        echo "âœ… ZIP files created"
        ls -la *.zip

  # Step 3: Generate plugin-info.json
  - name: 'ubuntu'
    id: 'generate-info'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update && apt-get install -y jq
        VERSION=$(cat /workspace/version.txt)
        DATE=$(date -u +"%Y-%m-%d %H:%M:%S")
        
        # Extract plugin info
        PLUGIN_FILE="${_PLUGIN_SLUG}.php"
        PLUGIN_NAME=$(grep -oP "Plugin Name:\s*\K.+" $PLUGIN_FILE | head -1 || echo "${_PLUGIN_SLUG}")
        REQUIRES_WP=$(grep -oP "Requires at least:\s*\K.+" $PLUGIN_FILE | head -1 || echo "5.8")
        REQUIRES_PHP=$(grep -oP "Requires PHP:\s*\K.+" $PLUGIN_FILE | head -1 || echo "7.4")
        TESTED_WP=$(grep -oP "Tested up to:\s*\K.+" $PLUGIN_FILE | head -1 || echo "6.4")
        
        # Create or update plugin-info.json
        if [ -f "plugin-info.json" ]; then
          cp plugin-info.json build/plugin-info.json
        else
          echo '{"sections":{}}' > build/plugin-info.json
        fi
        
        cd build
        jq --arg v "$VERSION" \
           --arg url "https://storage.googleapis.com/${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-${VERSION}.zip" \
           --arg date "$DATE" \
           --arg name "$PLUGIN_NAME" \
           --arg tested "$TESTED_WP" \
           --arg requires "$REQUIRES_WP" \
           --arg requires_php "$REQUIRES_PHP" \
           '.version = $v | .download_url = $url | .last_updated = $date | .name = $name | .tested = $tested | .requires = $requires | .requires_php = $requires_php' \
           plugin-info.json > plugin-info-updated.json
        
        mv plugin-info-updated.json plugin-info.json
        
        echo "âœ… Generated plugin-info.json:"
        cat plugin-info.json

  # Step 4: Upload files to GCS
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-files'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(cat /workspace/version.txt)
        
        # Upload versioned ZIP
        gsutil cp build/${_PLUGIN_SLUG}-${VERSION}.zip \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-${VERSION}.zip
        
        # Upload latest ZIP
        gsutil cp build/${_PLUGIN_SLUG}-latest.zip \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-latest.zip
        
        # Upload plugin-info.json with no-cache
        gsutil -h "Cache-Control:no-cache, max-age=0" \
          cp build/plugin-info.json \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/plugin-info.json
        
        echo "âœ… Files uploaded to GCS"

  # Step 5: Set public access
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'set-permissions'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(cat /workspace/version.txt)
        
        gsutil acl ch -u AllUsers:R gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-${VERSION}.zip || true
        gsutil acl ch -u AllUsers:R gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-latest.zip || true
        gsutil acl ch -u AllUsers:R gs://${_BUCKET}/${_PLUGIN_SLUG}/plugin-info.json || true
        
        echo "âœ… Public access set"

  # Step 6: Summary
  - name: 'ubuntu'
    id: 'summary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(cat /workspace/version.txt)
        
        echo ""
        echo "========================================"
        echo "ðŸŽ‰ Deployment Complete!"
        echo "========================================"
        echo ""
        echo "Plugin: ${_PLUGIN_SLUG}"
        echo "Version: $VERSION"
        echo ""
        echo "Files:"
        echo "  â€¢ https://storage.googleapis.com/${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}-${VERSION}.zip"
        echo "  â€¢ https://storage.googleapis.com/${_BUCKET}/${_PLUGIN_SLUG}/plugin-info.json"
        echo ""
        echo "========================================"

# Substitution defaults (override in trigger settings)
substitutions:
  _BUCKET: 'tanapon-wp-plugins'
  _PLUGIN_SLUG: 'acf-rest-api'

options:
  logging: CLOUD_LOGGING_ONLY

timeout: '600s'