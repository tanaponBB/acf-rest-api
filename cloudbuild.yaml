steps:
  # Step 1: Build Plugin ZIP
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        apt-get update && apt-get install -y zip jq

        VERSION=$$(grep -oP "Version:\s*\K[0-9.]+" ${_PLUGIN_SLUG}.php | head -1)
        echo "========================================="
        echo "ðŸ”¨ Building version: $$VERSION"
        echo "========================================="

        mkdir -p build/${_PLUGIN_SLUG}
        cp ${_PLUGIN_SLUG}.php build/${_PLUGIN_SLUG}/
        cp -r includes build/${_PLUGIN_SLUG}/ 2>/dev/null || true
        cp readme.txt build/${_PLUGIN_SLUG}/ 2>/dev/null || true

        cd build
        zip -r ${_PLUGIN_SLUG}.zip ${_PLUGIN_SLUG}
        echo "$$VERSION" > version.txt

        echo "âœ… ZIP created"

  # Step 2: Upload ZIP (PRIVATE)
  - name: "gcr.io/cloud-builders/gsutil"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "ðŸ“¤ Uploading ZIP to PRIVATE bucket..."
        gsutil -h "Cache-Control:no-cache, max-age=0" \
          cp build/${_PLUGIN_SLUG}.zip \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}.zip
        echo "âœ… ZIP uploaded (PRIVATE)"

  # Step 3: Generate Signed URL (1 day expiry)
  - name: "gcr.io/cloud-builders/gsutil"
    entrypoint: "bash"
    secretEnv: ["SA_KEY"]
    args:
      - "-c"
      - |
        apt-get update && apt-get install -y jq

        VERSION=$$(cat build/version.txt)
        echo "ðŸ” Generating Signed URL (1 day expiry)..."

        # Save SA key to temp file
        echo "$$SA_KEY" > /tmp/sa-key.json

        # Generate Signed URL (24 hours)
        # FIX APPLIED: Added "-r asia-southeast1" to bypass metadata permission check.
        # If your bucket is in the US, change "asia-southeast1" to "US" or "us-central1".
        SIGNURL_OUTPUT=$$(gsutil signurl -r asia-southeast1 -d 24h /tmp/sa-key.json \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/${_PLUGIN_SLUG}.zip 2>&1)
        
        # Extract URL - it's the last field containing https://
        SIGNED_URL=$$(echo "$$SIGNURL_OUTPUT" | grep "https://" | grep -oP 'https://[^\s]+')

        # Clean up key
        rm -f /tmp/sa-key.json

        # Validate URL
        if [ -z "$$SIGNED_URL" ]; then
          echo "âŒ ERROR: Failed to generate signed URL"
          echo "Output was:"
          echo "$$SIGNURL_OUTPUT"
          exit 1
        fi

        echo "âœ… Signed URL generated successfully"
        echo "   URL length: $${#SIGNED_URL} characters"

        EXPIRY_DATE=$$(date -u -d '+1 days' '+%Y-%m-%d %H:%M:%S')
        CURRENT_DATE=$$(date -u '+%Y-%m-%d %H:%M:%S')
        echo "   Expires: $$EXPIRY_DATE UTC"

        # Update plugin-info.json
        cp plugin-info.json build/ 2>/dev/null || echo '{}' > build/plugin-info.json

        jq --arg v "$$VERSION" \
           --arg url "$$SIGNED_URL" \
           --arg date "$$CURRENT_DATE" \
           --arg expires "$$EXPIRY_DATE" \
           '.version=$$v | .download_url=$$url | .last_updated=$$date | .download_url_expires=$$expires' \
           build/plugin-info.json > build/tmp.json && mv build/tmp.json build/plugin-info.json

        echo ""
        echo "ðŸ“„ plugin-info.json preview:"
        cat build/plugin-info.json | jq '{version, download_url_expires}'

  # Step 4: Upload plugin-info.json (PUBLIC)
  - name: "gcr.io/cloud-builders/gsutil"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "ðŸ“¤ Uploading plugin-info.json..."
        gsutil -h "Cache-Control:no-cache, max-age=0" \
          -h "Content-Type:application/json" \
          cp build/plugin-info.json \
          gs://${_BUCKET}/${_PLUGIN_SLUG}/plugin-info.json

        gsutil acl ch -u AllUsers:R gs://${_BUCKET}/${_PLUGIN_SLUG}/plugin-info.json

        echo ""
        echo "========================================="
        echo "ðŸŽ‰ Deployment Complete!"
        echo "========================================="
        echo "â€¢ ZIP: PRIVATE (Signed URL only)"
        echo "â€¢ URL expires: 1 day"
        echo "â€¢ plugin-info.json: PUBLIC"
        echo "========================================="

# Secret from Secret Manager
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/plugin-signer-key/versions/latest
      env: "SA_KEY"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "900s"